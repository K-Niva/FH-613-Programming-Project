<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Status Checker</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .container {
            width: 80%;
            max-width: 600px;
            margin: 20px auto;
            border: 1px solid #ccc;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1, h3 { text-align: center; }
        #progress-container { text-align: center; }
        #download-area { text-align: center; background-color: #f0f9f2; }
        #download-area a, #download-area button {
            display: inline-block;
            margin: 10px;
            padding: 10px 15px;
            text-decoration: none;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 5px;
        }
        #download-link { background-color: #28a745; color: white; }
        #reset-button { background-color: #007bff; color: white; border: none; }
        .message-log { font-size: 0.9em; color: #666; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container" id="form-container">
        <h1>RMIT Marketing Ad URL Uploader</h1>
        <p>The first column of your file should contain the URLs to be checked.</p>
        <p><strong>Note:</strong> Your processed file will be emailed to you. You can also download it here once the scan is complete.</p>
        
        <form id="upload-form" enctype="multipart/form-data">
            <label for="email">Recipient Email:</label>
            <input type="email" id="email" name="email" required>
            <br><br>

            <label for="file">File to Process:</label>
            <input type="file" id="file" name="file" accept=".xlsx,.csv" required>
            <br><br>

            <input type="submit" value="Upload and Process">
        </form>
    </div>

    <div id="progress-container" class="container" style="display: none;">
        <h3 id="progress-status">Starting...</h3>
        <div id="message-log" class="message-log"></div>
    </div>

    <div id="download-area" class="container" style="display: none;">
        <h3>Processing complete!</h3>
        <a id="download-link">Download the updated file</a>
        <button id="reset-button">Process Another File</button>
    </div>

    <script>
    document.getElementById('upload-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        // --- UI Element References ---
        const formContainer = document.getElementById('form-container');
        const progressContainer = document.getElementById('progress-container');
        const downloadArea = document.getElementById('download-area');
        const progressStatus = document.getElementById('progress-status');
        const messageLog = document.getElementById('message-log');
        const downloadLink = document.getElementById('download-link');

        let pollingInterval; // To hold our setInterval ID

        // --- Reset and Show Progress UI ---
        formContainer.style.display = 'none';
        progressContainer.style.display = 'block';
        downloadArea.style.display = 'none';
        progressStatus.textContent = 'Uploading file...';
        messageLog.innerHTML = '';

        try {
            // 1. Upload the file and get the Job ID
            const uploadResponse = await fetch('/upload', { method: 'POST', body: formData });
            const uploadResult = await uploadResponse.json();

            if (!uploadResult.success) {
                throw new Error(uploadResult.message || 'The server rejected the file upload.');
            }

            progressStatus.textContent = 'File accepted. Waiting for processing to start...';
            const jobId = uploadResult.job_id;

            // 2. Start polling for status updates
            pollingInterval = setInterval(async () => {
                try {
                    const statusResponse = await fetch(`/status/${jobId}`);
                    const data = await statusResponse.json();
                    const jobStatus = data.job_status || 'PENDING';
                    
                    if (data.total_urls && !messageLog.textContent) {
                         messageLog.textContent = `Found ${data.total_urls} rows to process in ${data.original_filename || 'your file'}.`;
                    }

                    if (jobStatus === 'PROCESSING') {
                        const total = data.total_urls || 0;
                        const processed = data.processed_urls || 0;
                        progressStatus.textContent = `${processed} / ${total} has been processed`;
                    }

                    if (jobStatus === 'COMPLETE') {
                        clearInterval(pollingInterval);
                        progressStatus.textContent = `All ${data.total_urls || 0} rows have been processed!`;
                        
                        downloadLink.href = `/download/${data.result_filename}`;
                        
                        progressContainer.style.display = 'none';
                        downloadArea.style.display = 'block';
                    }

                    if (jobStatus === 'ERROR') {
                        clearInterval(pollingInterval);
                        const errorMessage = data.error_message || 'An unknown error occurred during processing.';
                        throw new Error(errorMessage);
                    }

                } catch (pollError) {
                    clearInterval(pollingInterval);
                    // Re-throw to be caught by the main catch block
                    throw pollError;
                }
            }, 2500); // Poll every 2.5 seconds

        } catch (error) {
            if (pollingInterval) clearInterval(pollingInterval);
            
            progressStatus.textContent = 'An Error Occurred!';
            messageLog.innerHTML = `<span style="color: red;"><strong>Error:</strong> ${error.message}</span>`;
            
            // Show the download area but hide the download link, showing only the reset button
            progressContainer.style.display = 'none';
            downloadArea.style.display = 'block';
            downloadArea.querySelector('h3').textContent = 'Failed!';
            downloadLink.style.display = 'none';
        }
    });

    document.getElementById('reset-button').addEventListener('click', () => location.reload());
    </script>
</body>
</html>