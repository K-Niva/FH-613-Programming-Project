<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Status Checker</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .container {
            width: 80%;
            max-width: 600px;
            margin: 20px auto;
            border: 1px solid #ccc;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1, h3 { text-align: center; }
        .note { font-size: 0.9em; color: #555; }
        #progress-container { text-align: center; }
        #download-area { text-align: center; background-color: #f0f9f2; }
        #download-area a, #download-area button {
            display: inline-block;
            margin: 10px;
            padding: 10px 15px;
            text-decoration: none;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 5px;
        }
        #download-link { background-color: #28a745; color: white; }
        #reset-button { background-color: #007bff; color: white; border: none; }
        .message-log { font-size: 0.9em; color: #666; margin-top: 15px; }
        #skipped-message {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .schedule-group {
            border: 1px dashed #ccc;
            padding: 10px;
            margin-top: 15px;
            background-color: #fcfcfc;
        }
    </style>
</head>
<body>
    <div class="container" id="form-container">
        <h1>RMIT Marketing Ad URL Uploader</h1>
        <p>The first column of your file should contain the URLs to be checked.</p>

        <p class="note"><strong>Important:</strong> Only URLs from the <code>rmit.edu.au</code> domain will be processed. All other URLs will be skipped.</p>
        
        <form id="upload-form" enctype="multipart/form-data">
            <label for="email">Recipient Email:</label>
            <input type="email" id="email" name="email" required style="width: 95%; padding: 8px;">
            <br><br>

            <label for="file">File to Process (.xlsx or .csv):</label>
            <input type="file" id="file" name="file" accept=".xlsx,.csv" required>
            <br><br>

            <div class="schedule-group">
                <h3><input type="checkbox" id="enable-schedule" name="enable-schedule"> Schedule Daily Recurring Job</h3>
                <div id="schedule-options" style="display:none;">
                    <label for="schedule-start-date">Start Date:</label><br>
                    <input type="date" id="schedule-start-date" name="schedule_start_date"><br><br>
                    
                    <label for="schedule-end-date">End Date:</label><br>
                    <input type="date" id="schedule-end-date" name="schedule_end_date"><br><br>

                    <label for="schedule-process-time">Time to Process (AEST):</label><br>
                    <input type="time" id="schedule-process-time" name="schedule_process_time"><br><br>
                </div>
            </div>

            <input type="submit" value="Upload and Process">
        </form>
    </div>

    <div id="progress-container" class="container" style="display: none;">
        <h3 id="progress-status">Starting...</h3>
        <div id="message-log" class="message-log"></div>
    </div>

    <div id="download-area" class="container" style="display: none;">
        <h3>Processing complete!</h3>
        <p id="skipped-message" style="display: none;"></p>
        <a id="download-link">Download the updated file</a>
        <button id="reset-button">Process Another File</button>

        <p class="note" style="margin-top: 20px;">
            A copy of the processed file has been sent to your email. This file is now scheduled to be checked automatically every day at given time.
        </p>
    </div>

    <script>
    document.getElementById('enable-schedule').addEventListener('change', function() {
        const scheduleOptions = document.getElementById('schedule-options');
        scheduleOptions.style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('upload-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const formContainer = document.getElementById('form-container');
        const progressContainer = document.getElementById('progress-container');
        const downloadArea = document.getElementById('download-area');
        const progressStatus = document.getElementById('progress-status');
        const messageLog = document.getElementById('message-log');
        const downloadLink = document.getElementById('download-link');
        const skippedMessage = document.getElementById('skipped-message');

        let pollingInterval;

        formContainer.style.display = 'none';
        progressContainer.style.display = 'block';
        downloadArea.style.display = 'none';
        progressStatus.textContent = 'Uploading file...';
        messageLog.innerHTML = '';
        skippedMessage.style.display = 'none';

        try {
            const uploadResponse = await fetch('/upload', { method: 'POST', body: formData });
            const uploadResult = await uploadResponse.json();

            if (!uploadResult.success) {
                throw new Error(uploadResult.message || 'The server rejected the file upload.');
            }

            progressStatus.textContent = 'File accepted. Waiting for processing to start...';
            const jobId = uploadResult.job_id;

            pollingInterval = setInterval(async () => {
                try {
                    const statusResponse = await fetch(`/status/${jobId}`);
                    const data = await statusResponse.json();
                    const jobStatus = data.job_status || 'PENDING';
                    
                    if (data.total_urls && !messageLog.textContent) {
                         messageLog.textContent = `Found ${data.total_urls} rows to process in ${data.original_filename || 'your file'}.`;
                    }

                    if (jobStatus === 'PROCESSING') {
                        const total = data.total_urls || 0;
                        const processed = data.processed_urls || 0;
                        progressStatus.textContent = `${processed} / ${total} has been processed`;
                    }

                    if (jobStatus === 'COMPLETE') {
                        clearInterval(pollingInterval);
                        progressStatus.textContent = `All ${data.total_urls || 0} rows have been processed!`;
                        
                        if (data.skipped_urls && data.skipped_urls > 0) {
                            const totalUrls = data.total_urls || 0;
                            if (data.skipped_urls === totalUrls) {
                                skippedMessage.textContent = `All ${totalUrls} URLs were skipped as they were not from the rmit.edu.au domain.`;
                            } else {
                                skippedMessage.textContent = `${data.skipped_urls} of ${totalUrls} URLs were skipped as they were not from the rmit.edu.au domain.`;
                            }
                            skippedMessage.style.display = 'block';
                        }
                        
                        downloadLink.href = `/download/${data.result_filename}`;
                        
                        progressContainer.style.display = 'none';
                        downloadArea.style.display = 'block';
                    }

                    if (jobStatus === 'ERROR') {
                        clearInterval(pollingInterval);
                        const errorMessage = data.error_message || 'An unknown error occurred during processing.';
                        throw new Error(errorMessage);
                    }

                } catch (pollError) {
                    clearInterval(pollingInterval);
                    throw pollError;
                }
            }, 2500);

        } catch (error) {
            if (pollingInterval) clearInterval(pollingInterval);
            
            progressContainer.style.display = 'none';
            downloadArea.style.display = 'block';
            downloadArea.querySelector('h3').textContent = 'Failed!';
            downloadLink.style.display = 'none';
            messageLog.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${error.message}</p>`;
            downloadArea.prepend(messageLog);
        }
    });

    document.getElementById('reset-button').addEventListener('click', () => location.reload());
    </script>
</body>
</html>
